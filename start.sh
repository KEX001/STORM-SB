#!/bin/bash

set -e

if [ -z "$PORT" ]; then
  echo "á´˜á´Ê€á´› Éªêœ± É´á´á´› êœ±á´‡á´›. êœ±á´›á´Ê€á´ á´€Éª Éªêœ± á´…á´‡êœ°á´€á´œÊŸá´›ÉªÉ´É¢ á´›á´ 8080 ðŸŒ"
  PORT=8080
fi

if [ -z "$FLASK_APP" ]; then
  echo "êœ°ÊŸá´€êœ±á´‹ á´€á´˜á´˜ Éªêœ± É´á´á´› êœ±á´‡á´›. [êœ±á´›á´Ê€á´ á´€Éª] Éªêœ± á´…ÉªÊ€á´‡á´„á´›ÊŸÊ Ê™á´á´á´›ÉªÉ´É¢ á´›á´ Éªá´›êœ± êœ±á´‡Ê€á´ á´‡Ê€ êœ°ÊŸá´€êœ±á´‹ âš¡"
  export FLASK_APP=kex:create_app
fi

function shutdown {
    echo "á´‡xá´‡á´„á´œá´›ÉªÉ´É¢ á´€ êœ±á´á´á´á´›Êœ á´‡xÉªá´›... Ê™Ê€ÉªÉ´É¢ÉªÉ´É¢ á´›Êœá´‡ êœ±á´›á´Ê€á´ Ê™á´á´› á´›á´ á´€ êœ±á´€êœ°á´‡ Êœá´€ÊŸá´› ðŸŒªï¸"
    kill -TERM "$gunicorn_pid" 2>/dev/null
    wait "$gunicorn_pid"
    echo "êœ°á´á´œÉ´á´… á´€ êœ±á´‡Ê€á´ á´‡Ê€ á´‡Ê€Ê€á´Ê€. Êá´á´œÊ€ á´…á´‡á´˜ÊŸá´Êá´á´‡É´á´› á´á´€Ê É´á´á´› Ê™á´‡ á´„á´É´É´á´‡á´„á´›á´‡á´… á´›á´ á´›Êœá´‡ êœ±á´›á´Ê€á´'êœ± êœ±á´‡Ê€á´ á´‡Ê€. êœ±Êœá´œá´›á´›ÉªÉ´É¢ á´…á´á´¡É´ á´›Êœá´‡ á´…á´‡á´˜ÊŸá´Êá´á´‡É´á´› á´›á´ á´‹á´‡á´‡á´˜ Êá´á´œÊ€ Ê™á´á´› êœ±á´€êœ°á´‡... ðŸ”’"
}

trap shutdown SIGTERM

gunicorn -w 4 -b 0.0.0.0:$PORT kex:create_app &
gunicorn_pid=$!

echo "êœ±á´›á´€Ê€á´›ÉªÉ´É¢ Êá´á´œÊ€ êœ±á´›á´Ê€á´ êœ±á´˜á´€á´ Ê™á´á´› [á´˜Ê€Éªá´á´‡ á´ á´‡Ê€êœ±Éªá´É´ á´ 3.1.1] âš¡"
python3 main.py >> main.log 2>&1 &

wait "$gunicorn_pid"
